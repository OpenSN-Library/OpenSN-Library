# 平台数据同步设计

## 1. 数据结构

```go
const (
    SATELLITE = "Satellite"
    G_STATION = "GroundStation"
)

type Position struct {
    Latitude  float64
    Longitude float64
    Altiutde  float64
}

type Instance struct {
    InstanceID        string
    Name              string
    Type              string
    PositionChangable bool
    ContainerID       string
    NodeID            uint32
    Namespace         string
    LinksID           []string
    Extra             map[string]string
}

type Veth struct{
    Index uint32
    Name string
    MacAddr uint64
}

type Bridge struct {
    Index uint32
    Name string
}

type VethPair struct {
    VethID string
    ContainerSideVeth Veth
    KernelSideVeth Veth
    ContainerID Veth
}

type Link struct {
    LinkID string
    ConnectInstancesID [2]string
    VethIDs [2]string
    CrossNode bool
    ConnBridge *Bridge
    ConnectionChangable bool
}

type Namespace struct {
    Name string
    AllocedInstances int
    NodeInstanceMap map[string]string
    NodeLinkMap map[string]string
}

const (
    MAX_INSTANCE_NODE = 128
    MASTER_NODE_MAKEUP = 16
)

type Node struct {
    NodeID uint32
    FreeInstance int
    IsMasterNode bool
    L3AddrV4 uint32
    L3AddrV6 uint64
    L2Addr uint64 // 低六字节储存MAC地址
    NsInstanceMap map[string]string
    NsLinkMap map[string]string
}

```

## 2. 数据同步设计

数据同步主要有两个纬度
* 跨机器同步数据 
* 跨模块同步数据

我们将数据区分为三个类型
1. 静态数据：在一次仿真中只会在初始化时进行改变的数据，例如仿真卫星、地面站的静态数据
2. 动态数据：在仿真过程中可能会发生改变的数据，但这些数据改变不需要被监听，在需要时访问即可，例如链路的拓扑结构
3. 监听数据：在仿真过程中会不断改变，而且在改变时需要一些功能立刻进行反应，例如卫星的位置数据、节点所具有的卫星列表

### 2.1 etcd同步设计

#### 2.1.1 节点内的实例列表

* Key:`/node_${NODE_INDEX}/inst_list`
* Value: JSON序列化后的字符串，对象格式
* 用途: 节点内模块监听这一字段，当发生变更后，就需要更新本机的静态数据部分，把新加入实例放入计算列表

### 2.2 redis静态同步设计

* Key:`node_%d_instances`
* Value: Redis Hashmap结构， field为对象ID，值为对象JSON序列化后的结果
* 用途: 储存节点模拟的实例的信息

### 2.3 redis动态同步设计