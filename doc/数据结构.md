# 平台数据同步设计

## 1. 数据结构

```go
const (
    SATELLITE = "Satellite"
    G_STATION = "GroundStation"
)

type Position struct {
    Latitude  float64
    Longitude float64
    Altiutde  float64
}

type Instance struct {
    InstanceID        string
    Name              string
    Type              string
    PositionChangable bool
    ContainerID       string
    NodeID            uint32
    Namespace         string
    LinksID           []string
    Extra             map[string]string
}

type Veth struct{
    Index uint32
    Name string
    MacAddr uint64
}

type Bridge struct {
    Index uint32
    Name string
}

type VethPair struct {
    VethID string
    ContainerSideVeth Veth
    KernelSideVeth Veth
    ContainerID Veth
}

type Link struct {
    LinkID string
    ConnectInstancesID [2]string
    VethIDs [2]string
    CrossNode bool
    ConnBridge *Bridge
    ConnectionChangable bool
}

type Namespace struct {
    Name string
    AllocedInstances int
    NodeInstanceMap map[string]string
    NodeLinkMap map[string]string
}

const (
    MAX_INSTANCE_NODE = 128
    MASTER_NODE_MAKEUP = 16
)

type Node struct {
    NodeID uint32
    FreeInstance int
    IsMasterNode bool
    L3AddrV4 uint32
    L3AddrV6 uint64
    L2Addr uint64 // 低六字节储存MAC地址
    NsInstanceMap map[string]string
    NsLinkMap map[string]string
}

```

## 2. 数据同步设计

数据同步主要有两个纬度
* 跨机器同步数据 
* 跨模块同步数据

我们将数据区分为三个类型
1. 静态数据：在一次仿真中只会在初始化时进行改变的数据，例如仿真卫星、地面站的静态数据
2. 动态数据：在仿真过程中可能会发生改变的数据，但这些数据改变不需要被监听，在需要时访问即可，例如链路的拓扑结构
3. 监听数据：在仿真过程中会不断改变，而且在改变时需要一些功能立刻进行反应，例如卫星的位置数据、节点所具有的卫星列表

### 2.1 etcd同步设计

#### 2.1.1 节点内的项目命名空间列表

* Key:`/node_${NODE_INDEX}/instance_list`
* Value: JSON序列化后的字符串，对象格式为数组
* 用途: 节点内模块监听这一字段，当发生变更后，就需要更新本机的静态数据部分，把新加入实例放入计算列表

#### 2.1.2 节点实例的位置信息

* Key:`/node_${NODE_INDEX}/positions`
* Value: JSON序列化后的字符串，对象格式为Object，对象ID->位置信息
* 用途: 网络管理/其他模块获取本节点卫星位置信息

#### 2.1.3 平台活跃节点列表

* Key: `/node_index_list`
* Value: 平台拥有的活跃节点Index列表
* 用途: 主服务节点监听新节点和加入和节点离开事件, 节点守护进程为自己分配新ID
> 使用需要加锁，目前实现的是加上指定时间后释放的锁

### 2.2 redis静态同步设计

#### 2.2.1 节点实例信息

* Key:`node_%d_instances`
* Value: Redis Hashmap结构， field为对象ID，值为对象JSON序列化后的结果
* 用途: 储存节点模拟的实例的信息

#### 2.2.2 节点信息

* Key:`nodes`
* Value: Redis Hashmap结构, field为Index, 值为JSON序列化后的结果
* 用途: 储存加入平台的节点实例信息

#### 2.2.3 节点index分配序号

* Key: `next_node_index`
* Value: 整数字符串，代表下一个加入平台的节点的Index
* 用途: 为加入节点分配index

### 2.3 redis动态同步设计

#### 2.3.1 平台心跳Key

* Key: `node_heart_beat`
* Value: 节点的心跳字段, 为Redis点HashMap数据结构
* 用途: 子节点守护进程会每隔一段时间更新这个键值，代表自己还活着

#### 2.3.2 运行的命名空间列表

* Key: `namespaces`
* Value: Redis Hashmap结构, field为Name, 值为JSON序列化后的结果
* 用途: 储存现有的命名空间信息